parameters:
  os: ''

steps:

# Clean
- checkout: self
  clean: true

# Use node 8, npm 5
- task: NodeTool@0
  displayName: Use node 8
  inputs:
    versionSpec: 8.x

- script: npm i -g npm@6.9.0 --force
  displayName: Use npm version 6.9.0

# npm install
- script: npm install
  displayName: npm install

# Verify min agent demands
- script: |
    cd ci/verifyMinAgentDemands
    npm install
  displayName: npm install min agent demands

- script: node ./ci/verifyMinAgentDemands/index.js
  displayName: Verify min agent demands

# Filter out unchanged tasks
- script: node ./ci/filter-tasks.js
  displayName: Filter out unchanged tasks
  env:
    PACKAGE_ENDPOINT: $(Package.Endpoint)
    PACKAGE_TOKEN: $(Package.Token)

# Build
- script: node make.js build --task "$(task_pattern)"
  displayName: Build

- script: node ./ci/check-tasks.js
  displayName: Check that tasks has no duplicated libs
  
# Test
- script: node make.js test
  displayName: Run tests
- script: node make.js testLegacy --task "$(task_pattern)"
  displayName: Legacy tests with node 6
